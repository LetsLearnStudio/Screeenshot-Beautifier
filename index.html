<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Image Editor</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
</head>
<body>
  <div class="image-editor-container">
    <div class="editor-wrapper">
      <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
          <canvas id="canvas"></canvas>
          <div class="upload-overlay" id="uploadOverlay">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Click or drag and drop your image here</span>
            <span class="upload-subtitle">Support JPG, PNG files</span>
          </div>
          <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>
      </div>
      
      <div class="sidebar">
        <div class="sidebar-section">
          <h3><i class="fas fa-crop-alt"></i> Image Styling</h3>
          <div class="tooltip">
            <div>
              <label for="aspectRatio">Aspect Ratio</label>
              <select id="aspectRatio" aria-label="Image aspect ratio">
                <option value="original">Original</option>
                <option value="square">Square (1:1)</option>
                <option value="horizontal">Landscape (16:9)</option>
                <option value="vertical">Portrait (9:16)</option>
              </select>
            </div>
            <span class="tooltiptext">Choose how your image will be sized and cropped</span>
          </div>
          
          <div class="tooltip">
            <div>
              <label for="cropIntensity">Crop</label>
              <input type="range" id="cropIntensity" min="0" max="49" value="0">
            </div>
            <span class="tooltiptext">Crop image from all sides (maintains aspect ratio)</span>
          </div>
          
          <div class="tooltip">
            <div>
              <label for="cornerRadius">Image Radius</label>
              <input type="range" id="cornerRadius" min="0" max="100" value="0">
            </div>
            <span class="tooltiptext">Adjust the roundness of image corners</span>
          </div>
          
          <div class="tooltip">
            <div>
              <label for="backgroundSize">Padding</label>
              <input type="range" id="backgroundSize" min="0" max="100" value="20">
            </div>
            <span class="tooltiptext">Add space around your image</span>
          </div>
          
          <div class="tooltip">
            <div>
              <label for="bgCornerRadius">BG Radius</label>
              <input type="range" id="bgCornerRadius" min="0" max="100" value="0">
            </div>
            <span class="tooltiptext">Adjust the roundness of background edges</span>
          </div>

          <div class="tooltip">
            <div>
              <label for="shadowIntensity">Shadow</label>
              <input type="range" id="shadowIntensity" min="0" max="50" value="0">
            </div>
            <span class="tooltiptext">Adjust the drop shadow around the image</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <h3><i class="fas fa-palette"></i> Color & Gradient</h3>
          <div class="tooltip">
            <div>
              <label>Gradient Type</label>
              <select id="gradientType">
                <option value="linear">Linear</option>
                <option value="radial">Radial</option>
              </select>
            </div>
            <span class="tooltiptext">Select gradient style</span>
          </div>
          
          <div class="tooltip">
            <div>
              <label>Gradient Colors</label>
              <div class="color-pickers">
                <button onclick="randomizeColors()" class="icon-button" title="Random colors">
                  <i class="fas fa-random"></i>
                </button>
                <input type="color" id="color1" value="#3498db" title="Start color">
                <button onclick="flipColors()" class="icon-button" title="Flip colors">
                  <i class="fas fa-exchange-alt"></i>
                </button>
                <input type="color" id="color2" value="#9b59b6" title="End color">
              </div>
            </div>
            <span class="tooltiptext">Select colors for background gradient</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <h3><i class="fas fa-magic"></i> Blur & Editing</h3>
          <div class="tooltip">
            <div>
              <input type="checkbox" id="blurToggle" onclick="toggleBlurMode()">
              <label for="blurToggle">Blur Mode</label>
            </div>
            <span class="tooltiptext">Enable blur editing tool</span>
          </div>
          
          <div id="blurIntensityDiv" style="display: none;" class="tooltip">
            <div>
              <label for="blurIntensity">Blur Intensity</label>
              <input type="range" id="blurIntensity" min="1" max="20" value="5">
            </div>
            <span class="tooltiptext">Control the strength of the blur effect</span>
          </div>
          
          <div id="shapeDiv" style="display: none;" class="tooltip">
            <div>
              <label for="shape">Blur Shape</label>
              <select id="shape">
                <option value="rectangle">Rectangle</option>
                <option value="circle">Circle</option>
              </select>
            </div>
            <span class="tooltiptext">Choose shape for blur tool</span>
          </div>
        </div>

        <div class="sidebar-section">
          <h3><i class="fas fa-sliders-h"></i> Actions</h3>
          <div class="bottom-ribbon">
            <div class="tooltip">
              <button onclick="undo()" class="icon-button" aria-label="Undo">
                <i class="fas fa-undo"></i>
              </button>
              <span class="tooltiptext">Revert to previous edit</span>
            </div>
            <div class="tooltip">
              <button onclick="redo()" class="icon-button" aria-label="Redo">
                <i class="fas fa-redo"></i>
              </button>
              <span class="tooltiptext">Restore undone edit</span>
            </div>
            <div class="tooltip">
              <button onclick="downloadImage()" class="icon-button" aria-label="Download">
                <i class="fas fa-download"></i>
              </button>
              <span class="tooltiptext">Save your edited image</span>
            </div>
            <div class="tooltip">
              <button onclick="resetCanvas()" class="icon-button" aria-label="Reset">
                <i class="fas fa-trash-alt"></i>
              </button>
              <span class="tooltiptext">Clear all edits and start over</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="script.js"></script>

  <script>
// New improved version
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://letslearnstudio.github.io') return;
  
  if (event.data.type === 'FROM_EXTENSION' && event.data.image) {
    let attempts = 0; // ✅ Local counter per image
    const maxAttempts = 3;

    const tryLoad = () => {
      const img = new Image();
      
      img.onload = () => {
        image.src = event.data.image;
        image.onload = () => {
          drawImageWithEffects();
          history = [];
          currentState = -1;
          uploadOverlay.classList.add('hidden');
        };
      };
      
      img.onerror = () => {
        if(attempts < maxAttempts) {
          attempts++; // ✅ Isolated to this image
          setTimeout(tryLoad, 500 * attempts); // ✅ Exponential backoff
        } else {
          alert('Failed to load image after 3 attempts. Please try again.');
          cleanupCanvas(); // ✅ Proper cleanup
        }
      };
      
      img.src = event.data.image;
    };

    tryLoad();
  }
});

function cleanupCanvas() {
  // Reset canvas to initial state
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  uploadOverlay.classList.remove('hidden');
  image = new Image(); // Reset image object
}
</script>
</body>
</html>
